# PocketIDInstance configuration
# Creates a PocketIDInstance custom resource when enabled
# At least 1 PocketIDInstance is required. If disabled create the resource manually
instance:
  enabled: true
  name: pocket-id
  labels: {}
  annotations: {}

  # PocketIDInstance spec configuration
  # Anything from PocketIDInstance.spec can be added here
  spec:
    # Kind of workload to create, Deployment or StatefulSet
    deploymentType: Deployment

    # Container image to run
    image: ghcr.io/pocket-id/pocket-id:latest

    # How the operator authenticates with the instance
    # Technically optional but required to manage pocket-id via custom resources
    # auth:
    #   userRef:
    #     name: pocket-id-operator
    #     # namespace: default  # Defaults to instance namespace
    #   apiKeyName: pocket-id-operator

    # Encryption Key (required)
    # Use either 'value' for a plain text value (16 byte minimum) or 'valueFrom' for a reference
    encryptionKey:
      # value: "your-encryption-key-here"

      # Source the value from a secret/configMap/etc
      valueFrom:
        secretKeyRef:
          name: pocket-id-encryption-key
          key: encryption-key

    # Database URL
    # If left as a filepath the instance will use a sqlite db
    # To use postgres configure the full uri, e.g. postgresql://user:password@host:port/dbname
    databaseUrl:
      value: "/app/data/pocket-id.db"
      # valueFrom:
      #   secretKeyRef:
      #     name: pocket-id-db
      #     key: uri

    # External URL Pocket-ID can be reached at
    # appUrl: "https://auth.example.com"

    # Additional environment variables
    env: []
    # - name: LOG_LEVEL
    #   value: "debug"
    # - name: SMTP_HOST
    #   value: "smtp.example.com"
    # - name: SMTP_PASSWORD
    #   valueFrom:
    #     secretKeyRef:
    #       name: smtp-credentials
    #       key: password

    # Persistence configuration
    # Mounts to /app/data. If spec.deploymentType is StatefulSet will be mounted as a VolumeClaimTemplate
    # if not enabled will mount emptyDir. It is possible to run stateless if using postgres
    persistence:
      enabled: false
      # existingClaim: ""
      # storageClass: ""
      size: 1Gi
      accessModes:
        - ReadWriteOnce

    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 65534
      fsGroup: 65534
      SeccompProfile:
        type: RuntimeDefault

    containerSecurityContext:
      AllowPrivilegeEscalation: false
      RunAsNonRoot: true
      ReadOnlyRootFilesystem: true
      Capabilities:
        drop:
          - ALL

    # Controls whether the container's user namespace is separate from the host
    # Set to false to enable user namespace isolation
    # true by default (no user namespace isolation, container runs in host user namespace)
    hostUsers: true

    # resources:
    #   requests:
    #     cpu: 50m
    #     memory: 128Mi
    #   limits:
    #     memory: 512Mi

  # HTTPRoute configuration (Gateway API)
  # Creates an HTTPRoute for the PocketIDInstance when enabled
  route:
    enabled: false

    # Name of the HTTPRoute (defaults to instance name if not set)
    # name: ""

    labels: {}

    annotations: {}

    # Gateway parent references
    parentRefs:
      - name: gateway
        # namespace: default
        # sectionName: https

    # Hostnames for the route
    # Will be automatically set to the hostname from instance.spec.appUrl if not specified
    hostnames: []
    # - auth.example.com

# Configure the controller manager deployment
manager:
  replicas: 1

  image:
    repository: ghcr.io/aclerici38/pocket-id-operator
    tag: "" # Defaults to Chart.appVersion when empty
    pullPolicy: IfNotPresent

  # Arguments
  args:
    - --leader-elect

  # Environment variables
  env: []

  # Pod-level security settings
  podSecurityContext:
    runAsNonRoot: true
    seccompProfile:
      type: RuntimeDefault

  # Container-level security settings
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: true

  # Resource limits and requests
  resources:
    limits:
      cpu: 500m
      memory: 128Mi
    requests:
      cpu: 10m
      memory: 64Mi

# Custom Resource Definitions
crd:
  enable: true # Install CRDs with the chart
  keep: false # Keep CRDs when uninstalling

# Extra Kubernetes manifests to deploy
# Supports templating with Helm values
extraManifests: []
  # Example:
  # - |
  #   apiVersion: v1
  #   kind: Secret
  #   metadata:
  #     name: {{ .Values.instance.name }}-encryption-key
  #     namespace: {{ .Release.Namespace }}
  #   stringData:
  #     encryption-key: "my-secret-encryption-key"
  #

  # - |
  #   apiVersion: pocketid.internal/v1alpha1
  #   kind: PocketIDUser
  #   metadata:
  #     name: admin-user
  #     namespace: {{ .Release.Namespace }}
  #   spec:
  #     admin: true
  #     email:
  #       value: "admin@example.com"
  #     apiKeys:
  #     - name: admin-api-key
  #       description: "Admin API key"
  #       expiresAt: "2030-01-01T00:00:00Z"
  # 
  #       reference to an existing apikey stored in a secret
  #       secretRef:
  #         name: my-existing-secret
  #         key: api-key
