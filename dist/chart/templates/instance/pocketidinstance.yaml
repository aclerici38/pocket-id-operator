{{- if .Values.instance.enabled }}
apiVersion: pocketid.internal/v1alpha1
kind: PocketIDInstance
metadata:
  name: {{ .Values.instance.name | default "pocket-id" }}
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: pocket-id
    app.kubernetes.io/instance: {{ .Values.instance.name | default "pocket-id" }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    helm.sh/chart: {{ include "chart.name" . }}
    {{- with .Values.instance.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with .Values.instance.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- $specWithoutSpecial := omit .Values.instance.spec "env" "encryptionKey" }}
  {{- toYaml $specWithoutSpecial | nindent 2 }}
  {{- if .Values.instance.spec.encryptionKey }}
  encryptionKey:
    {{- if .Values.instance.spec.encryptionKey.value }}
    value: {{ .Values.instance.spec.encryptionKey.value | quote }}
    {{- else if .Values.instance.spec.encryptionKey.valueFrom }}
    valueFrom:
      {{- toYaml .Values.instance.spec.encryptionKey.valueFrom | nindent 6 }}
    {{- end }}
  {{- end }}
  {{- if .Values.instance.spec.env }}
  env:
    {{- include "instance.stringifyEnv" .Values.instance.spec.env | nindent 4 }}
  {{- end }}
{{- end }}
