name: Test Chart

on:
  workflow_call:
    inputs:
      image:
        description: Operator image to use for chart installation test.
        required: true
        type: string
  workflow_dispatch:
    inputs:
      image:
        description: Operator image to use for chart installation test.
        required: true
        type: string

permissions:
  actions: write
  contents: read
  packages: read

env:
  # renovate: datasource=github-releases depName=kubernetes-sigs/kind
  KIND_VERSION: v0.31.0

jobs:
  test:
    name: Lint and install test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1

      - name: Extract image parts
        id: image
        run: |
          IMAGE="${{ inputs.image }}"
          echo "repository=${IMAGE%:*}" >> "$GITHUB_OUTPUT"
          echo "tag=${IMAGE##*:}" >> "$GITHUB_OUTPUT"

      - name: Resolve latest release
        id: release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG=$(gh release view --repo ${{ github.repository }} --json tagName -q .tagName)
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "image=ghcr.io/${REPO_OWNER}/pocket-id-operator:${TAG}" >> "$GITHUB_OUTPUT"
          echo "chart_version=${TAG#v}" >> "$GITHUB_OUTPUT"
          echo "chart=oci://ghcr.io/${REPO_OWNER}/charts/pocket-id-operator" >> "$GITHUB_OUTPUT"

      - name: Lint Helm chart with instance
        run: helm lint dist/chart --values .github/helm-test-values.yaml
        
      - name: Lint Helm chart without instance
        run: helm lint dist/chart --set instance.enabled=false

      - name: Package chart
        run: |
          mkdir -p dist/chart-packages
          helm package dist/chart \
            --version "0.0.0" \
            --app-version "${{ steps.image.outputs.tag }}" \
            --destination dist/chart-packages

      - name: Cache kind
        id: cache-kind
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: /usr/local/bin/kind
          key: kind-${{ runner.os }}-${{ runner.arch }}-${{ env.KIND_VERSION }}

      - name: Install kind
        if: steps.cache-kind.outputs.cache-hit != 'true'
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-$(go env GOARCH)
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Create kind cluster
        run: kind create cluster

      - name: Install released chart
        run: |
          helm install test-release ${{ steps.release.outputs.chart }} \
            --version ${{ steps.release.outputs.chart_version }} \
            --create-namespace \
            --namespace pocket-id-operator-system \
            --values .github/helm-test-values.yaml \
            --set operator.image.repository=${{ steps.image.outputs.repository }} \
            --set operator.image.tag=${{ steps.release.outputs.tag }} \
            --wait \
            --timeout 2m

      - name: Upgrade to current chart
        run: |
          helm upgrade test-release dist/chart-packages/*.tgz \
            --namespace pocket-id-operator-system \
            --values .github/helm-test-values.yaml \
            --set operator.image.repository=${{ steps.image.outputs.repository }} \
            --set operator.image.tag=${{ steps.image.outputs.tag }} \
            --wait \
            --timeout 2m

      - name: Debug on failure
        if: failure()
        run: |
          echo "=== Manager Pod Logs ==="
          kubectl logs -n pocket-id-operator-system -l control-plane=controller-manager --tail=100 || true
          echo "=== PocketIDInstance Status ==="
          kubectl get pocketidinstance -n pocket-id-operator-system -o yaml || true
          echo "=== PocketIDUser Status ==="
          kubectl get pocketiduser -n pocket-id-operator-system -o yaml || true
          echo "=== Pocket-ID Pod Logs ==="
          kubectl logs -n pocket-id-operator-system -l app.kubernetes.io/name=pocket-id --tail=100 || true
          echo "=== All Resources ==="
          kubectl get all -n pocket-id-operator-system || true
          echo "=== Pod Describe ==="
          kubectl describe pods -n pocket-id-operator-system || true

      - name: Verify chart installation
        run: |
          helm status test-release --namespace pocket-id-operator-system
          kubectl get all -n pocket-id-operator-system

      - name: Uninstall test chart
        if: always()
        run: |
          helm uninstall test-release --namespace pocket-id-operator-system || true
