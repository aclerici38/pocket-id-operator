name: Test Chart

on:
  workflow_call:
    inputs:
      image:
        description: Operator image to use for chart installation test.
        required: true
        type: string
  workflow_dispatch:
    inputs:
      image:
        description: Operator image to use for chart installation test.
        required: true
        type: string

permissions:
  actions: write
  contents: read
  packages: read

env:
  # renovate: datasource=github-releases depName=kubernetes-sigs/kind
  KIND_VERSION: v0.31.0

jobs:
  test:
    name: Lint and install test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Lint Helm chart
        run: helm lint dist/chart

      - name: Package chart
        run: |
          mkdir -p dist/chart-packages
          helm package dist/chart \
            --version "0.0.0" \
            --app-version "0.0.0" \
            --destination dist/chart-packages

      - name: Cache kind
        id: cache-kind
        uses: actions/cache@v5
        with:
          path: /usr/local/bin/kind
          key: kind-${{ runner.os }}-${{ runner.arch }}-${{ env.KIND_VERSION }}

      - name: Install kind
        if: steps.cache-kind.outputs.cache-hit != 'true'
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-$(go env GOARCH)
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Create kind cluster
        run: kind create cluster

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull operator image
        run: docker pull ${{ inputs.image }}

      - name: Pull Pocket-ID application image
        # renovate: datasource=docker depName=ghcr.io/pocket-id/pocket-id
        run: docker pull ghcr.io/pocket-id/pocket-id:v2.2.0-distroless@sha256:ad2d21a7b31d6b4f1d999caec794a5b5edeb97fc40801947158d62befd4203e3

      - name: Load images into kind
        # renovate: datasource=docker depName=ghcr.io/pocket-id/pocket-id
        run: |
          kind load docker-image ghcr.io/pocket-id/pocket-id:v2.2.0-distroless@sha256:ad2d21a7b31d6b4f1d999caec794a5b5edeb97fc40801947158d62befd4203e3
          kind load docker-image ${{ inputs.image }}

      - name: Extract image parts
        id: image
        run: |
          IMAGE="${{ inputs.image }}"
          echo "repository=${IMAGE%:*}" >> "$GITHUB_OUTPUT"
          echo "tag=${IMAGE##*:}" >> "$GITHUB_OUTPUT"

      - name: Test chart installation
        run: |
          helm install test-release dist/chart-packages/*.tgz \
            --create-namespace \
            --namespace pocket-id-operator-system \
            --set manager.image.repository=${{ steps.image.outputs.repository }} \
            --set manager.image.tag=${{ steps.image.outputs.tag }} \
            --set instance.spec.encryptionKey.value="test-key-16chars" \
            --wait \
            --timeout 2m

      - name: Debug on failure
        if: failure()
        run: |
          echo "=== Manager Pod Logs ==="
          kubectl logs -n pocket-id-operator-system -l control-plane=controller-manager --tail=100 || true
          echo "=== PocketIDInstance Status ==="
          kubectl get pocketidinstance -n pocket-id-operator-system -o yaml || true
          echo "=== Pocket-ID Pod Logs ==="
          kubectl logs -n pocket-id-operator-system -l app.kubernetes.io/name=pocket-id --tail=100 || true
          echo "=== All Resources ==="
          kubectl get all -n pocket-id-operator-system || true
          echo "=== Pod Describe ==="
          kubectl describe pods -n pocket-id-operator-system || true

      - name: Verify chart installation
        run: |
          helm status test-release --namespace pocket-id-operator-system
          kubectl get all -n pocket-id-operator-system

      - name: Uninstall test chart
        if: always()
        run: |
          helm uninstall test-release --namespace pocket-id-operator-system || true
