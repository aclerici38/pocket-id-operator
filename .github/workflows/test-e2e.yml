name: E2E Tests

on:
  workflow_call:
    inputs:
      image:
        description: Optional image to preload for e2e tests.
        required: false
        type: string
      skip_artifact:
        description: Skip downloading and loading the image artifact (e.g. when the image is already in the registry).
        required: false
        type: boolean
        default: false
  workflow_dispatch:
    inputs:
      image:
        description: Optional image to preload for e2e tests.
        required: false
        type: string
      skip_artifact:
        description: Skip downloading and loading the image artifact (e.g. when the image is already in the registry).
        required: false
        type: boolean
        default: false

permissions:
  actions: write
  contents: read
  packages: read

env:
  # renovate: datasource=github-releases depName=kubernetes-sigs/kind
  KIND_VERSION: v0.31.0
  # renovate: datasource=github-releases depName=kubernetes-sigs/controller-tools
  CONTROLLER_TOOLS_VERSION: v0.20.1
  # renovate: datasource=github-releases depName=kubernetes-sigs/kustomize
  KUSTOMIZE_VERSION: v5.7.1
  # renovate: datasource=github-releases depName=onsi/ginkgo
  GINKGO_VERSION: v2.28.1

jobs:
  test-e2e:
    name: Run e2e tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true
          cache-dependency-path: go.sum

      - name: Cache tool binaries
        uses: actions/cache@v5
        with:
          path: bin
          key: tools-${{ runner.os }}-go-${{ hashFiles('go.mod') }}-kustomize-${{ env.KUSTOMIZE_VERSION }}-controller-gen-${{ env.CONTROLLER_TOOLS_VERSION }}-ginkgo-${{ env.GINKGO_VERSION }}

      - name: Cache kind
        id: cache-kind
        uses: actions/cache@v5
        with:
          path: /usr/local/bin/kind
          key: kind-${{ runner.os }}-${{ runner.arch }}-${{ env.KIND_VERSION }}

      - name: Install kind
        if: steps.cache-kind.outputs.cache-hit != 'true'
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-$(go env GOARCH)
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Extract image tag
        if: inputs.image != '' && !inputs.skip_artifact
        id: tag
        run: |
          IMAGE_TAG="${{ inputs.image }}"
          echo "name=${IMAGE_TAG##*:}" >> "$GITHUB_OUTPUT"

      - name: Download image artifact
        if: inputs.image != '' && !inputs.skip_artifact
        uses: actions/download-artifact@v7
        with:
          name: operator-image-${{ steps.tag.outputs.name }}
          path: /tmp

      - name: Load image
        if: inputs.image != '' && !inputs.skip_artifact
        run: docker load -i /tmp/operator-image-${{ steps.tag.outputs.name }}.tar

      - name: Pull image
        if: inputs.image != '' && inputs.skip_artifact
        run: docker pull ${{ inputs.image }}

      - name: Run e2e tests
        run: |
          if [ -n "${{ inputs.image }}" ]; then
            make test-e2e-only IMG=${{ inputs.image }}
          else
            make test-e2e-only
          fi
