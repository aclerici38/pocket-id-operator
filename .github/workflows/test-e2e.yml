name: E2E Tests

on:
  workflow_call:
    inputs:
      image:
        description: Optional image to preload for e2e tests.
        required: false
        type: string
  workflow_dispatch:
    inputs:
      image:
        description: Optional image to preload for e2e tests.
        required: false
        type: string

permissions:
  actions: write
  contents: read
  packages: read

env:
  # renovate: datasource=github-releases depName=kubernetes-sigs/kind
  KIND_VERSION: v0.31.0
  # renovate: datasource=github-releases depName=kubernetes-sigs/controller-tools
  CONTROLLER_TOOLS_VERSION: v0.20.1
  # renovate: datasource=github-releases depName=kubernetes-sigs/kustomize
  KUSTOMIZE_VERSION: v5.7.1
  # renovate: datasource=github-releases depName=onsi/ginkgo
  GINKGO_VERSION: v2.28.1

jobs:
  test-e2e:
    name: Run e2e tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
          cache: true
          cache-dependency-path: go.sum

      - name: Cache tool binaries
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: bin
          key: tools-${{ runner.os }}-go-${{ hashFiles('go.mod') }}-kustomize-${{ env.KUSTOMIZE_VERSION }}-controller-gen-${{ env.CONTROLLER_TOOLS_VERSION }}-ginkgo-${{ env.GINKGO_VERSION }}

      - name: Cache kind
        id: cache-kind
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: /usr/local/bin/kind
          key: kind-${{ runner.os }}-${{ runner.arch }}-${{ env.KIND_VERSION }}

      - name: Install kind
        if: steps.cache-kind.outputs.cache-hit != 'true'
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-$(go env GOARCH)
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Extract image tag
        if: inputs.image != ''
        id: tag
        run: |
          IMAGE_TAG="${{ inputs.image }}"
          echo "name=${IMAGE_TAG##*:}" >> "$GITHUB_OUTPUT"

      - name: Download image artifact
        if: inputs.image != ''
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: operator-image-${{ steps.tag.outputs.name }}
          path: /tmp

      - name: Load image
        if: inputs.image != ''
        run: docker load -i /tmp/operator-image-${{ steps.tag.outputs.name }}.tar

      - name: Run e2e tests
        run: |
          if [ -n "${{ inputs.image }}" ]; then
            make test-e2e-only IMG=${{ inputs.image }}
          else
            make test-e2e-only
          fi
