name: E2E Tests

on:
  workflow_call:
    inputs:
      image:
        description: Optional image to preload for e2e tests.
        required: false
        type: string
  workflow_dispatch:
    inputs:
      image:
        description: Optional image to preload for e2e tests.
        required: false
        type: string

permissions:
  contents: read
  packages: read

jobs:
  test-e2e:
    name: Run e2e tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install the latest version of kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/latest/kind-linux-$(go env GOARCH)
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Log in to GitHub Container Registry
        if: inputs.image != ''
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull cached image
        if: inputs.image != ''
        run: docker pull ${{ inputs.image }}

      - name: Run e2e tests
        run: |
          if [ -n "${{ inputs.image }}" ]; then
            make test-e2e IMG=${{ inputs.image }}
          else
            make test-e2e
          fi
