name: E2E Tests

on:
  workflow_call:
    inputs:
      image:
        description: Optional image to preload for e2e tests.
        required: false
        type: string
  workflow_dispatch:
    inputs:
      image:
        description: Optional image to preload for e2e tests.
        required: false
        type: string

permissions:
  actions: write
  contents: read
  packages: read

env:
  # renovate: datasource=github-releases depName=kubernetes-sigs/kind
  KIND_VERSION: v0.31.0
  # renovate: datasource=github-releases depName=kubernetes-sigs/controller-tools
  CONTROLLER_TOOLS_VERSION: v0.20.0
  # renovate: datasource=github-releases depName=kubernetes-sigs/kustomize
  KUSTOMIZE_VERSION: v5.7.1

jobs:
  test-e2e:
    name: Run e2e tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true
          cache-dependency-path: go.sum

      - name: Cache tool binaries
        uses: actions/cache@v5
        with:
          path: bin
          key: tools-${{ runner.os }}-kustomize-${{ env.KUSTOMIZE_VERSION }}-controller-gen-${{ env.CONTROLLER_TOOLS_VERSION }}

      - name: Cache kind
        id: cache-kind
        uses: actions/cache@v5
        with:
          path: /usr/local/bin/kind
          key: kind-${{ runner.os }}-${{ runner.arch }}-${{ env.KIND_VERSION }}

      - name: Install kind
        if: steps.cache-kind.outputs.cache-hit != 'true'
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-$(go env GOARCH)
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Log in to GitHub Container Registry
        if: inputs.image != ''
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull cached image
        if: inputs.image != ''
        run: docker pull ${{ inputs.image }}

      - name: Run e2e tests
        run: |
          if [ -n "${{ inputs.image }}" ]; then
            make test-e2e-only IMG=${{ inputs.image }}
          else
            make test-e2e-only
          fi
